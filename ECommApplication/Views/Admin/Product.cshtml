@model ECommApplication.Models.Product
@{
    ViewBag.Title = "Product";
}
<script src="//cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script type="text/javascript">
    function bindSubCategory(subCategory) {
        var categoryID = $('#CategoryID').val()
        $.ajax({
            url: "/Bind/BindSubCategory",
            type: "Get",
            data: { 'CategoryID': categoryID},
            datatype: "json",
            success: function (data) {
                $("#SubCategoryID").children('option:not(:first)').remove();
                $.each(data.subcategory, function (i, subcategory) {
                    $("#SubCategoryID").append('<option value="' + subcategory.SubCategoryID + '">' + subcategory.SubCategoryName + '</option>');
                });
                if (subCategory != undefined && subCategory != '')
                    $('#SubCategoryID').val(subCategory)
            }
        });
    }
    function editProduct(e, productId) {
        e.preventDefault();

        $.ajax({
            url: "/Bind/BindProducts",
            type: "Get",
            data: { 'ProductId': productId },
            datatype: "json",
            success: function (data) {
                console.log(data)
                var product = data.products[0];
                $('#CategoryID').val(product.subCategory.category.CategoryID)
                bindSubCategory(product.subCategory.SubCategoryID)
              //  $('#SubCategoryID').val(product.subCategory.SubCategoryID)
                $('#ProductId').val(product.ProductId)
                $('#ProductName').val(product.ProductName)
                $('#ProductDescription').val(product.ProductDescription)
                $('#ProductSize').val(product.ProductSize)
                $('#ProductWeight').val(product.ProductWeight)
                $('#BasePrice').val(product.BasePrice)
                $('#ShippingCharges').val(product.ShippingCharges)
                $('#GST').val(product.GST)
                $('#ServiceTax').val(product.ServiceTax)
                $('#FinalPrice').val(product.FinalPrice)
                //$('#DisplayAtHomePage').val(product.DisplayAtHomePage)
                //$('#IsActive').val(product.IsActive)
                if (product.DisplayAtHomePage)
                    $('#DisplayAtHomePage').prop("checked")

                if(product.IsActive)
                    $('#IsActive').prop("checked")
                debugger;
                // load product image data table
                if (product.productImages.length > 0) {
                    productsImages = product.productImages
                    loadProductImagesDataTable();
                }

            }
        });
    }
    function loadProductImagesDataTable() {
        $('#tblProductImages').DataTable({
            "destroy":true,
            "ordering": true,
            "bJQueryUI": true,
            "sPaginationType": "full_numbers",
            "sDom": '<""l>t<"F"fp>',
            "data": productsImages,
            "searching": true,
            "columns": [
                { 'data': 'ImageID', "name": "ImageID" },
                { 'data': 'Caption', "name": "Caption" },
                { 'data': 'Priority', "name": "Priority" },
                { 'data': 'IsActive', "name": "IsActive" },
                {
                    "render": function (data, type, obj, meta) {
                        return `<img src='` + obj.productImagePath + `' class="span3"  >`;
                    }
                },
                {
                    "render": function (data, type, obj, meta) {
                        return `<a class="btn btn-primary" href="#" onclick="javascript:editSubCategory(event,'` + obj.ID + `')">Edit</a>

                            `;
                    }
                },
            ]

        });
    }
    function uploadImage() {

        var formdata = new FormData(); //FormData object
        var fileInput = document.getElementById('imageFile');
        //Iterating through each files selected in fileInput
        for (i = 0; i < fileInput.files.length; i++) {
            //Appending each file to FormData object
            formdata.append(fileInput.files[i].name, fileInput.files[i]);
        }
        //formdata.append("caption", $('#Caption').val())
        //formdata.append("priority", $('#Priority').val())
        //formdata.append("isActive", $('#IsActiveImage').val())



        var objArr = [];

        formdata.append("Caption", $('#Caption').val());
        formdata.append("Priority", $('#Priority').val());

        //JSON obj
        formdata.append('objArr', objArr);

        $.ajax({
            url: '/Admin/UploadImage',
            type: "POST",
            processData: false, // Not to process data
            data: formdata,
            contentType:  false,
            success: function (result) {
                productsImages = result.productImages
                loadProductImagesDataTable();
            },
            error: function (err) {
                alert(err.statusText);
            }
        });



    }
    $(document).ready(function () {
        //bindSubCategory($('#CategoryID'));
        $('#btnSaveImage').click(function (e) {
            e.preventDefault();
            uploadImage()
        })
        var productsData = "";
        var productsImages = "";
        var category = null;
        $.ajax({
            url: "/Bind/BindProducts",
            type: "POST",
            datatype: "json",
            success: function (data) {
                productsData = data;
                loadProductsDataTable();
            },
        });

        function loadProductsDataTable() {
            $('#tblProducts').DataTable({
                "destroy":true,
                "ordering": true,
                //"bJQueryUI": true,
                //"sPaginationType": "full_numbers",
                //"sDom": '<""l>t<"F"fp>',
                "scrollX": true,
                "PaginationType": "full",
                "scrollCollapse": true,
                "data": productsData.products,
                "searching": true,
                "fixedColumns": {
                   "rightColumns": 1
                },
                "dom":"Blfrtip",
                "columns": [
                    { 'data': 'ProductId', "name": "ProductId" },
                    { 'data': 'ProductName', "name": "ProductName" },
                    { 'data': 'ProductDescription', "name": "ProductDescription" },
                    { 'data': 'ProductSize', "name": "ProductSize" },
                    { 'data': 'ProductWeight', "name": "ProductWeight" },
                    { 'data': 'BasePrice', "name": "BasePrice" },
                    { 'data': 'ShippingCharges', "name": "ShippingCharges" },
                    { 'data': 'GST', "name": "GST" },
                    { 'data': 'ServiceTax', "name": "ServiceTax" },
                    { 'data': 'FinalPrice', "name": "FinalPrice" },
                    { 'data': 'DisplayAtHomePage', "name": "DisplayAtHomePage" },
                    { 'data': 'IsActive', "name": "IsActive" },
                    {
                        "render": function (data, type, obj, meta) {
                            return `<a class="btn btn-primary" href="#" onclick="javascript:editProduct(event,'` + obj.ProductId + `')">Edit</a>

                            `;
                        }
                    },
                ]

            });
        }
    //<a class="btn btn-danger" href="#" onclick="javascript:deleteCategory(event,'` + obj.ID + `')">Delete</a>
    //  <a class="btn btn-danger" href="#" onclick="javascript:deleteCategory(event,'` + obj.ProductID + `')">Delete</a>
    })
</script>

<div class="container-fluid">

    <div class="row-fluid">
        <div class="span12">
            <div class="widget-box">
                <div class="widget-title">
                    <span class="icon"> <i class="icon-align-justify"></i> </span>
                    <h5>Product-info</h5>
                </div>
                <div class="widget-content nopadding">
                    <form action="/Admin/Product" method="post" class="form-horizontal">
                        @Html.AntiForgeryToken()
                        <div class="control-group span5">
                            <label class="control-label">Category :</label>
                            <div class="controls">
                                @Html.HiddenFor(a => a.ProductId)
                                @Html.DropDownListFor(a => a.subCategory.category.CategoryID, new SelectList((new ECommApplication.Models.SubCategory().getCategories()), "CategoryID", "CategoryName"), "--Select--", new { @onchange = "bindSubCategory()", @id = "CategoryID" })

                            </div>
                        </div>
                        <div class="control-group span5">
                            <label class="control-label">Sub Category :</label>
                            <div class="controls">
                                @Html.DropDownListFor(a => a.subCategory.SubCategoryID, new SelectList(string.Empty, "Value", "Text"), "--Select--", new { @id = "SubCategoryID" })
                            </div>
                        </div>
                        <div class="control-group span5">
                            <label class="control-label">Product Name:</label>
                            <div class="controls">
                                @Html.TextBoxFor(a => a.ProductName, new { @maxlength = "100" })
                                @Html.ValidationMessageFor(a => a.ProductName, "", new { @class = "help-inline" })
                            </div>
                        </div>
                        <div class="control-group span5">
                            <label class="control-label">Product Description:</label>
                            <div class="controls">
                                @Html.TextBoxFor(a => a.ProductDescription, new { @maxlength = "100" })
                            </div>
                        </div>
                        <div class="control-group span5">
                            <label class="control-label">Product Size:</label>
                            <div class="controls">
                                @Html.TextBoxFor(a => a.ProductSize, new { @maxlength = "100" })
                            </div>
                        </div>
                        <div class="control-group span5">
                            <label class="control-label">Product Weight:</label>
                            <div class="controls">
                                @Html.TextBoxFor(a => a.ProductWeight, new { @maxlength = "100" })
                            </div>
                        </div>
                        <div class="control-group span5">
                            <label class="control-label">Base Price:</label>
                            <div class="controls">
                                @Html.TextBoxFor(a => a.BasePrice, new { @maxlength = "100" })
                            </div>
                        </div>
                        <div class="control-group span5">
                            <label class="control-label">Shipping Charges:</label>
                            <div class="controls">
                                @Html.TextBoxFor(a => a.ShippingCharges, new { @maxlength = "100" })
                            </div>
                        </div>
                        <div class="control-group span5">
                            <label class="control-label">GST :</label>
                            <div class="controls">
                                @Html.TextBoxFor(a => a.GST, new { @maxlength = "100" })
                            </div>
                        </div>
                        <div class="control-group span5">
                            <label class="control-label">Service Tax:</label>
                            <div class="controls">
                                @Html.TextBoxFor(a => a.ServiceTax, new { @maxlength = "100" })
                            </div>
                        </div>
                        <div class="control-group span5">
                            <label class="control-label">Final Price:</label>
                            <div class="controls">
                                @Html.TextBoxFor(a => a.FinalPrice, new { @maxlength = "100" })
                            </div>
                        </div>
                        <div class="control-group span5">
                            <label class="control-label">Display at Home Page :</label>
                            <div class="controls">
                                @Html.CheckBoxFor(a => a.DisplayAtHomePage)
                            </div>
                        </div>
                        <div class="control-group span7">
                            <label class="control-label">Is Active :</label>
                            <div class="controls">
                                @Html.CheckBoxFor(a => a.IsActive)
                            </div>
                        </div>
                        <div class="widget-box">
                            <div class="widget-title">
                                <span class="icon"> <i class="icon-align-justify"></i> </span>
                                <h5>Product Image-info</h5>
                            </div>
                            <div class="widget-content nopadding">
                                <div class="control-group ">
                                    <label class="control-label">Upload Image</label>
                                    <div class="controls">
                                        <div class="uploader" id="uniform-undefined"><input type="file" size="19" style="opacity: 0;" id="imageFile"><span class="filename">No file selected</span><span class="action">Choose File</span></div>
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">Caption :</label>
                                    <div class="controls">
                                        <input type="text" id="Caption" name="Caption" />
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">Priority :</label>
                                    <div class="controls">
                                        <input type="text" id="Priority" name="Priority" />
                                    </div>
                                </div>
                                <div class="control-group">
                                    <label class="control-label">Is Active :</label>
                                    <div class="controls">
                                        <input type="checkbox" id="IsActiveImage" name="IsActiveImage" />
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn btn-success" id="btnSaveImage">Save Image</button>
                                    <button type="button" id="btnClear" class="btn btn-success" onclick="clearRecord()">Clear</button>
                                </div>
                                <div class="widget-box">
                                    <div class="widget-title">
                                        <span class="icon"><i class="icon-th"></i></span>
                                        <h5>Product Images:</h5>
                                    </div>
                                    <div class="widget-content nopadding">
                                        <table class="table table-bordered data-table" id="tblProductImages">
                                            <thead>
                                                <tr>
                                                    <th width="5%">ID</th>
                                                    <th width="30%">Caption</th>
                                                    <th width="10%">Priority</th>
                                                    <th width="10%">Active</th>
                                                    <th width="35%">Image</th>
                                                    <th width="20%"></th>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-success" id="btnSave">Save</button>
                            <button type="button" id="btnClear" class="btn btn-success" onclick="clearRecord()">Clear</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
        <hr />
        <div class="row-fluid">
            <div class="span12">
                <div class="widget-box">
                    <div class="widget-title">
                        <span class="icon"><i class="icon-th"></i></span>
                        <h5>Products:</h5>
                    </div>
                    <div class="widget-content nopadding">
                        <table class="table table-bordered data-table" id="tblProducts">
                            <thead>
                                <tr>
                                    <th width="20px">Product ID</th>
                                    <th width="300px">Product Name</th>
                                    <th width="300px">Product Description</th>
                                    <th width="20px">Product Size</th>
                                    <th width="20px">Product Weight</th>
                                    <th width="20px">Base Price</th>
                                    <th width="20px">Shipping Charges</th>
                                    <th width="20px">GST</th>
                                    <th width="20px">Service Tax</th>
                                    <th width="20px">Final Price</th>
                                    <th width="100px">Display At Home Page</th>
                                    <th width="20px">Active</th>
                                    <th width="20px"></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
